<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë³´ì„ ë…€ ë¦¬ë“¬ê²Œì„</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Pretendard", system-ui, sans-serif;
      background: #000;
      color: #222;
    }

    .wrap {
      display: flex;
      gap: 18px;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    /* ğŸ¨ ìº”ë²„ìŠ¤ ë°°ê²½ = ë³´ì„ ë…€ ì‚¬ì§„ */
    canvas {
      width: 600px;
      height: 500px;
      border-radius: 20px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
    }

    .panel {
      width: 260px;
      padding: 16px 18px;
      border-radius: 16px;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 10px 26px rgba(0,0,0,0.5);
      font-size: 14px;
      line-height: 1.7;
    }

    button {
      margin-top: 8px;
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      background: #ff7ac2;
      color: white;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
    }

    .keys { font-weight: 600; }
    .combo { font-weight: 700; color: #ff4ca3; }
    .tap-hint { margin-top: 8px; font-size: 12px; color:#555; }

    /* ğŸ”š ê²°ê³¼ì°½ UI */
    .result {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.88);
      padding: 26px 40px;
      border-radius: 20px;
      text-align: center;
      color: #fff;
      font-size: 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.75);
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 999;
    }
    .result.show {
      opacity: 1;
    }
    .hidden { display: none; }

    .result h2 {
      font-size: 26px;
      margin-bottom: 10px;
    }
    .result p {
      margin: 4px 0;
    }
    .result .big-score {
      margin-top: 10px;
      font-size: 24px;
      font-weight: 700;
      color: #ffd560;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="600" height="500"></canvas>

    <div class="panel">
      <h2>ë³´ì„ ë…€ ë¦¬ë“¬ê²Œì„ ğŸµ</h2>
      <p>ë…¸ë˜ ì¬ìƒ í›„, íŒì •ì„ ì—ì„œ <b>D F J K</b>ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.</p>
      <p class="keys">í‚¤ : D Â· F Â· J Â· K</p>

      <p>ì ìˆ˜: <span id="score">0</span></p>
      <p>ì½¤ë³´: <span id="combo" class="combo">0</span></p>
      <p>íŒì •: <span id="judge">-</span></p>

      <button id="startBtn">â–¶ ë…¸ë˜ ì‹œì‘ / ì¼ì‹œì •ì§€</button>
      <button id="tapBtn">ğŸ¼ ë°•ì ì°ê¸° ëª¨ë“œ</button>
      <p class="tap-hint">
        ë°•ì ì°ê¸° ëª¨ë“œì—ì„œ<br>
        ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ë°•ìì— ë§ê²Œ ëˆ„ë¥´ë©´<br>
        ì½˜ì†”ì— ì‹œê°„ì´ ì°í˜€ìš”.
      </p>
    </div>
  </div>

  <!-- ğŸ”š ê²°ê³¼ì°½ -->
  <div id="result" class="result hidden">
    <h2>RESULT</h2>
    <p>Perfect : <span id="rPerfect">0</span></p>
    <p>Great   : <span id="rGreat">0</span></p>
    <p>Good    : <span id="rGood">0</span></p>
    <p>Miss    : <span id="rMiss">0</span></p>
    <p>Max Combo : <span id="rCombo">0</span></p>
    <p class="big-score">Score : <span id="rScore">0</span></p>
  </div>

  <!-- ë…¸ë˜ íŒŒì¼ -->
  <audio id="bgm" src="inalchi.mp3" preload="auto"></audio>

  <audio id="hit" src="star.mp3.m4a" preload="auto"></audio>


  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const bgm = document.getElementById("bgm");
    const hitSound = document.getElementById("hit");


    const startBtn = document.getElementById("startBtn");
    const tapBtn = document.getElementById("tapBtn");

    const scoreEl = document.getElementById("score");
    const comboEl = document.getElementById("combo");
    const judgeEl = document.getElementById("judge");

    // ê²°ê³¼ì°½ ìš”ì†Œ
    const resultBox  = document.getElementById("result");
    const rPerfectEl = document.getElementById("rPerfect");
    const rGreatEl   = document.getElementById("rGreat");
    const rGoodEl    = document.getElementById("rGood");
    const rMissEl    = document.getElementById("rMiss");
    const rComboEl   = document.getElementById("rCombo");
    const rScoreEl   = document.getElementById("rScore");

    const W = canvas.width;
    const H = canvas.height;
    const columns = 4;
    const keyMap = ["d","f","j","k"];
    const colW = W / columns;
    const judgeLineY = H - 80;
    const noteSpeed = 550; // px/sec

    let notes = [];
    let started = false;
    let startPerfTime = 0;
    let score = 0;
    let combo = 0;
    let lastJudge = "-";
    let lastJudgeTimer = 0;

    // ğŸ”¢ íŒì • ê²°ê³¼ ì§‘ê³„
    let results = {
      Perfect: 0,
      Great: 0,
      Good: 0,
      Miss: 0
    };
    let maxCombo = 0;
    let resultShown = false;

    // ğŸµ ë³´ì„ ë…€ê°€ ì°ì€ ë°•ì ë¦¬ìŠ¤íŠ¸
    const chart = [
{ time: 2.17, column: 0 },
{ time: 2.71, column: 0 },
{ time: 3.15, column: 2 },
{ time: 3.38, column: 1 },
{ time: 3.67, column: 1 },
{ time: 3.90, column: 0 },
{ time: 4.44, column: 0 },
{ time: 4.92, column: 3 },
{ time: 5.14, column: 0 },
{ time: 5.37, column: 0 },
{ time: 5.61, column: 2 },
{ time: 6.15, column: 1 },
{ time: 6.38, column: 1 },
{ time: 6.60, column: 1 },
{ time: 6.83, column: 0 },
{ time: 7.07, column: 0 },
{ time: 7.33, column: 0 },
{ time: 8.10, column: 3 },
{ time: 8.58, column: 0 },
{ time: 9.10, column: 0 },
{ time: 9.55, column: 2 },
{ time: 10.04, column: 1 },
{ time: 10.27, column: 3 },
{ time: 10.50, column: 0 },
{ time: 10.73, column: 3 },
{ time: 10.99, column: 0 },
{ time: 11.17, column: 1 },
{ time: 11.71, column: 3 },
{ time: 11.97, column: 0 },
{ time: 12.21, column: 1 },
{ time: 12.45, column: 3 },
{ time: 12.70, column: 1 },
{ time: 12.95, column: 3 },
{ time: 13.20, column: 1 },
{ time: 13.95, column: 0 },
{ time: 14.42, column: 2 },
{ time: 14.67, column: 0 },
{ time: 15.18, column: 3 },
{ time: 15.42, column: 1 },
{ time: 15.65, column: 1 },
{ time: 16.16, column: 0 },
{ time: 16.63, column: 0 },
{ time: 16.88, column: 2 },
{ time: 17.13, column: 0 },
{ time: 17.36, column: 1 },
{ time: 17.86, column: 0 },
{ time: 18.14, column: 2 },
{ time: 18.35, column: 3 },
{ time: 18.60, column: 1 },
{ time: 18.85, column: 1 },
{ time: 19.10, column: 1 },
{ time: 19.88, column: 3 },
{ time: 20.36, column: 2 },
{ time: 20.84, column: 2 },
{ time: 21.08, column: 2 },
{ time: 21.32, column: 2 },
{ time: 21.59, column: 3 },
{ time: 22.12, column: 1 },
{ time: 22.62, column: 1 },
{ time: 22.84, column: 0 },
{ time: 23.08, column: 0 },
{ time: 23.32, column: 2 },
{ time: 23.82, column: 2 },
{ time: 24.06, column: 1 },
{ time: 24.30, column: 3 },
{ time: 24.55, column: 0 },
{ time: 24.77, column: 1 },
{ time: 25.03, column: 2 },
{ time: 25.74, column: 1 },
{ time: 26.21, column: 0 },
{ time: 26.49, column: 1 },
{ time: 27.04, column: 3 },
{ time: 27.29, column: 1 },
{ time: 27.51, column: 2 },
{ time: 28.01, column: 2 },
{ time: 28.50, column: 3 },
{ time: 28.73, column: 1 },
{ time: 28.97, column: 1 },
{ time: 29.19, column: 3 },
{ time: 29.69, column: 0 },
{ time: 29.93, column: 1 },
{ time: 30.18, column: 0 },
{ time: 30.42, column: 2 },
{ time: 30.70, column: 1 },
{ time: 30.93, column: 1 },
{ time: 31.76, column: 2 },
{ time: 32.26, column: 2 },
{ time: 32.70, column: 2 },
{ time: 33.16, column: 1 },
{ time: 33.62, column: 3 },
{ time: 33.83, column: 2 },
{ time: 34.08, column: 3 },
{ time: 34.56, column: 3 },
{ time: 35.05, column: 2 },
{ time: 35.29, column: 2 },
{ time: 35.55, column: 1 },
{ time: 36.06, column: 2 },
{ time: 36.59, column: 1 },
{ time: 36.81, column: 1 },
{ time: 37.06, column: 2 },
{ time: 37.53, column: 1 },
{ time: 38.08, column: 1 },
{ time: 38.31, column: 1 },
{ time: 38.56, column: 2 },
{ time: 39.03, column: 3 },
{ time: 39.55, column: 1 },
{ time: 39.77, column: 1 },
{ time: 40.02, column: 1 },
{ time: 40.53, column: 3 },
{ time: 41.02, column: 3 },
{ time: 41.24, column: 2 },
{ time: 41.47, column: 0 },
{ time: 41.95, column: 3 },
{ time: 42.48, column: 1 },
{ time: 42.71, column: 1 },
{ time: 42.95, column: 0 },
{ time: 43.46, column: 1 },
{ time: 43.98, column: 1 },
{ time: 44.20, column: 0 },
{ time: 44.43, column: 3 },
{ time: 44.91, column: 0 },
{ time: 45.45, column: 0 },
{ time: 45.70, column: 2 },
{ time: 45.94, column: 3 },
{ time: 46.24, column: 1 },
{ time: 46.41, column: 3 },
{ time: 46.77, column: 2 },
{ time: 46.91, column: 0 },
{ time: 47.21, column: 3 },
{ time: 47.42, column: 1 },
{ time: 47.68, column: 0 },
{ time: 49.35, column: 3 },
{ time: 49.52, column: 2 },
{ time: 49.88, column: 2 },
{ time: 52.25, column: 2 },
{ time: 52.50, column: 0 },
{ time: 52.76, column: 3 },
{ time: 53.01, column: 1 },
{ time: 53.29, column: 1 },
{ time: 53.55, column: 0 },
{ time: 53.78, column: 3 },
{ time: 54.03, column: 1 },
{ time: 54.70, column: 2 },
{ time: 55.25, column: 2 },
{ time: 55.76, column: 3 },
{ time: 56.24, column: 3 },
{ time: 56.74, column: 2 },
{ time: 57.27, column: 0 },
{ time: 57.73, column: 1 },
{ time: 58.21, column: 2 },
{ time: 58.74, column: 2 },
{ time: 59.25, column: 3 },
{ time: 59.75, column: 0 },
{ time: 60.22, column: 3 },
{ time: 60.73, column: 1 },
{ time: 61.69, column: 3 },
{ time: 62.03, column: 3 },
{ time: 62.16, column: 2 },
{ time: 62.32, column: 1 },
{ time: 62.62, column: 2 },
{ time: 62.77, column: 2 },
{ time: 62.95, column: 0 },
{ time: 63.06, column: 0 },
{ time: 63.20, column: 2 },
{ time: 63.36, column: 2 },
{ time: 63.49, column: 1 },
{ time: 63.63, column: 0 },
{ time: 63.83, column: 2 },
{ time: 63.93, column: 3 },
{ time: 64.08, column: 2 },
{ time: 64.25, column: 0 },
{ time: 64.38, column: 3 },
{ time: 64.52, column: 3 },
{ time: 64.70, column: 0 },
{ time: 65.04, column: 0 },
{ time: 65.29, column: 0 },
{ time: 65.52, column: 3 },
{ time: 65.76, column: 1 },
{ time: 66.01, column: 2 },
{ time: 66.29, column: 2 },
{ time: 66.53, column: 2 },
{ time: 66.76, column: 1 },
{ time: 67.03, column: 2 },
{ time: 67.28, column: 2 },
{ time: 68.08, column: 3 },
{ time: 68.31, column: 2 },
{ time: 68.56, column: 2 },
{ time: 68.82, column: 1 },
{ time: 70.00, column: 3 },
{ time: 70.27, column: 1 },
{ time: 70.50, column: 0 },
{ time: 70.75, column: 2 },
{ time: 71.00, column: 0 },
{ time: 71.38, column: 2 },
{ time: 71.52, column: 0 },
{ time: 71.79, column: 3 },
{ time: 72.01, column: 2 },
{ time: 72.50, column: 3 },
{ time: 72.99, column: 1 },
{ time: 73.55, column: 2 },
{ time: 73.95, column: 2 },
{ time: 74.46, column: 1 },
{ time: 74.67, column: 2 },
{ time: 74.94, column: 0 },
{ time: 75.40, column: 0 },
{ time: 75.90, column: 3 },
{ time: 76.42, column: 1 },
{ time: 76.93, column: 0 },
{ time: 77.39, column: 1 },
{ time: 77.88, column: 1 },
{ time: 78.39, column: 1 },
{ time: 78.86, column: 2 },
{ time: 79.37, column: 3 },
{ time: 79.88, column: 0 },
{ time: 80.37, column: 2 },
{ time: 80.89, column: 0 },
{ time: 81.12, column: 1 },
{ time: 81.37, column: 0 },
{ time: 81.82, column: 2 },
{ time: 82.35, column: 3 },
{ time: 82.61, column: 2 },
{ time: 82.83, column: 2 },
{ time: 83.28, column: 1 },
{ time: 83.76, column: 0 },
{ time: 84.01, column: 3 },
{ time: 84.28, column: 1 },
{ time: 84.75, column: 1 },
{ time: 85.27, column: 3 },
{ time: 85.52, column: 1 },
{ time: 85.76, column: 1 },
{ time: 86.24, column: 3 },
{ time: 86.76, column: 2 },
{ time: 87.01, column: 1 },
{ time: 87.24, column: 1 },
{ time: 87.72, column: 0 },
{ time: 88.21, column: 2 },
{ time: 88.42, column: 2 },
{ time: 88.67, column: 3 },
{ time: 89.18, column: 0 },
{ time: 89.67, column: 2 },
{ time: 89.92, column: 3 },
{ time: 90.14, column: 2 },
{ time: 90.62, column: 3 },
{ time: 91.19, column: 3 },
{ time: 91.43, column: 0 },
{ time: 91.69, column: 0 },
{ time: 92.17, column: 1 },
{ time: 92.67, column: 3 },
{ time: 92.87, column: 3 },
{ time: 93.14, column: 0 },
{ time: 93.43, column: 1 },
{ time: 93.64, column: 0 },
{ time: 93.98, column: 1 },
{ time: 94.15, column: 0 },
{ time: 94.38, column: 2 },
{ time: 94.61, column: 3 },
{ time: 94.86, column: 1 },
{ time: 96.59, column: 1 },
{ time: 96.74, column: 3 },
{ time: 96.93, column: 3 },
{ time: 97.12, column: 2 },
{ time: 97.52, column: 1 },
{ time: 97.87, column: 3 },
{ time: 98.40, column: 3 },
{ time: 99.06, column: 1 },
{ time: 100.46, column: 1 },
{ time: 100.96, column: 1 },
{ time: 101.46, column: 1 },
{ time: 101.94, column: 0 },
{ time: 102.43, column: 1 },
{ time: 102.94, column: 0 },
{ time: 103.45, column: 0 },
{ time: 103.93, column: 3 },
{ time: 104.43, column: 1 },
{ time: 104.93, column: 1 },
{ time: 105.39, column: 3 },
{ time: 105.90, column: 0 },
{ time: 106.41, column: 1 },
{ time: 106.92, column: 3 },
{ time: 107.42, column: 3 },
{ time: 107.94, column: 0 },
{ time: 108.44, column: 1 },
{ time: 108.93, column: 1 },
{ time: 109.40, column: 0 },
{ time: 109.88, column: 2 },
{ time: 110.36, column: 3 },
{ time: 110.84, column: 3 },
{ time: 111.33, column: 1 },
{ time: 111.80, column: 0 },
{ time: 112.29, column: 3 },
{ time: 112.78, column: 2 },
{ time: 113.25, column: 0 },
{ time: 113.75, column: 0 },
{ time: 114.27, column: 1 },
{ time: 114.78, column: 3 },
{ time: 115.28, column: 1 },
{ time: 115.77, column: 3 },
{ time: 116.27, column: 1 },
{ time: 116.76, column: 1 },
{ time: 117.25, column: 3 },
{ time: 117.73, column: 3 },
{ time: 118.21, column: 2 },
{ time: 118.71, column: 2 },
{ time: 119.21, column: 3 },
{ time: 119.68, column: 2 },
{ time: 120.19, column: 0 },
{ time: 120.69, column: 3 },
{ time: 121.18, column: 2 },
{ time: 121.70, column: 1 },
{ time: 122.18, column: 3 },
{ time: 122.65, column: 2 },
{ time: 123.16, column: 1 },
{ time: 123.64, column: 3 },
{ time: 124.15, column: 1 },
{ time: 124.61, column: 0 },
{ time: 125.11, column: 3 },
{ time: 125.62, column: 2 },
{ time: 126.12, column: 0 },
{ time: 126.60, column: 2 },
{ time: 127.08, column: 3 },
{ time: 127.57, column: 3 },
{ time: 128.05, column: 3 },
{ time: 128.53, column: 0 },
{ time: 128.98, column: 0 },
{ time: 129.46, column: 3 },
{ time: 129.97, column: 2 },
{ time: 130.44, column: 3 },
{ time: 130.93, column: 1 },
{ time: 131.43, column: 3 },
{ time: 131.93, column: 0 },
{ time: 132.42, column: 1 },
{ time: 132.92, column: 3 },
{ time: 133.43, column: 2 },
{ time: 133.96, column: 0 },
{ time: 134.42, column: 3 },
{ time: 134.94, column: 1 },
{ time: 135.43, column: 1 },
{ time: 135.92, column: 1 },
{ time: 136.41, column: 3 },
{ time: 136.89, column: 2 },
{ time: 137.38, column: 0 },
{ time: 137.86, column: 3 },
{ time: 138.38, column: 1 },
{ time: 138.88, column: 3 },
{ time: 139.36, column: 2 },
{ time: 139.84, column: 1 },
{ time: 140.31, column: 3 },
{ time: 140.81, column: 0 },
{ time: 141.30, column: 3 },
{ time: 141.78, column: 1 },
{ time: 142.25, column: 0 },
{ time: 142.76, column: 3 },
{ time: 143.25, column: 2 },
{ time: 143.72, column: 0 },
{ time: 144.22, column: 3 },
{ time: 144.70, column: 1 },
{ time: 145.25, column: 3 },
{ time: 145.74, column: 3 },
{ time: 146.24, column: 1 },
{ time: 146.73, column: 3 },
{ time: 147.19, column: 2 },
{ time: 147.70, column: 0 },
{ time: 148.23, column: 0 },
{ time: 148.69, column: 1 },
{ time: 149.17, column: 1 },
{ time: 149.66, column: 3 },
{ time: 150.21, column: 2 },
{ time: 150.69, column: 0 },
{ time: 151.18, column: 1 },
{ time: 151.71, column: 3 },
{ time: 152.22, column: 1 },
{ time: 152.70, column: 3 },
{ time: 153.19, column: 2 },
{ time: 153.65, column: 3 },
{ time: 154.14, column: 3 },
{ time: 154.61, column: 2 },
{ time: 155.10, column: 0 },
{ time: 155.58, column: 3 },
{ time: 156.06, column: 0 },
{ time: 156.52, column: 2 },
{ time: 157.00, column: 2 },
{ time: 157.50, column: 3 },
{ time: 158.01, column: 2 },
{ time: 158.52, column: 3 },
{ time: 159.02, column: 3 },
{ time: 159.50, column: 0 },
{ time: 160.00, column: 0 },
{ time: 160.50, column: 0 },
{ time: 160.76, column: 2 },
{ time: 161.01, column: 0 },
{ time: 161.30, column: 2 },
{ time: 161.78, column: 3 },
{ time: 162.23, column: 3 },
{ time: 162.50, column: 1 },
{ time: 162.73, column: 0 },
{ time: 162.97, column: 0 },
{ time: 163.46, column: 1 },
{ time: 163.71, column: 1 },
{ time: 163.96, column: 0 },
{ time: 164.21, column: 3 },
{ time: 164.46, column: 2 },
{ time: 164.73, column: 2 },
{ time: 165.43, column: 1 },
{ time: 165.93, column: 2 },
{ time: 166.42, column: 3 },
{ time: 166.93, column: 1 },
{ time: 167.44, column: 1 },
{ time: 167.67, column: 1 },
{ time: 167.91, column: 2 },
{ time: 168.14, column: 1 },
{ time: 168.38, column: 1 },
{ time: 168.64, column: 0 },
{ time: 169.14, column: 1 },
{ time: 169.39, column: 2 },
{ time: 169.62, column: 0 },
{ time: 169.87, column: 2 },
{ time: 170.10, column: 3 },
{ time: 170.35, column: 0 },
{ time: 170.62, column: 2 },
{ time: 171.34, column: 0 },
{ time: 171.81, column: 0 },
{ time: 172.05, column: 3 },
{ time: 172.57, column: 3 },
{ time: 172.80, column: 2 },
{ time: 173.04, column: 1 },
{ time: 173.50, column: 3 },
{ time: 174.01, column: 2 },
{ time: 174.24, column: 0 },
{ time: 174.48, column: 0 },
{ time: 174.71, column: 2 },
{ time: 175.23, column: 2 },
{ time: 175.49, column: 1 },
{ time: 175.74, column: 1 },
{ time: 176.02, column: 0 },
{ time: 176.24, column: 2 },
{ time: 176.50, column: 1 },
{ time: 177.16, column: 2 },
{ time: 177.68, column: 1 },
{ time: 178.19, column: 0 },
{ time: 178.43, column: 0 },
{ time: 178.67, column: 1 },
{ time: 178.94, column: 1 },
{ time: 179.46, column: 1 },
{ time: 179.92, column: 1 },
{ time: 180.18, column: 0 },
{ time: 180.40, column: 0 },
{ time: 180.66, column: 1 },
{ time: 181.15, column: 2 },
{ time: 181.39, column: 2 },
{ time: 181.64, column: 2 },
{ time: 181.86, column: 1 },
{ time: 182.13, column: 3 },
{ time: 182.41, column: 0 },
{ time: 183.09, column: 2 },
{ time: 183.61, column: 3 },
{ time: 183.88, column: 2 },
{ time: 184.39, column: 2 },
{ time: 184.60, column: 0 },
{ time: 184.83, column: 3 },
{ time: 185.33, column: 1 },
{ time: 185.80, column: 0 },
{ time: 186.07, column: 0 },
{ time: 186.30, column: 1 },
{ time: 186.54, column: 3 },
{ time: 187.04, column: 3 },
{ time: 187.31, column: 3 },
{ time: 187.53, column: 3 },
{ time: 187.77, column: 1 },
{ time: 188.04, column: 2 },
{ time: 188.31, column: 2 },
{ time: 190.96, column: 2 },
{ time: 191.48, column: 1 },
{ time: 192.01, column: 3 },
{ time: 192.27, column: 0 },
{ time: 192.51, column: 3 },
{ time: 192.79, column: 0 },
{ time: 193.30, column: 0 },
{ time: 193.78, column: 1 },
{ time: 194.01, column: 3 },
{ time: 194.24, column: 3 },
{ time: 194.48, column: 1 },
{ time: 194.96, column: 2 },
{ time: 195.21, column: 3 },
{ time: 195.44, column: 1 },
{ time: 195.68, column: 0 },
{ time: 195.93, column: 0 },
{ time: 196.16, column: 3 },
{ time: 196.92, column: 3 },
{ time: 197.44, column: 3 },
{ time: 197.91, column: 2 },
{ time: 198.38, column: 3 },
{ time: 198.90, column: 3 },
{ time: 199.13, column: 3 },
{ time: 199.38, column: 3 },
{ time: 199.63, column: 3 },
{ time: 199.88, column: 3 },
{ time: 200.15, column: 3 },
{ time: 200.68, column: 2 },
{ time: 200.92, column: 2 },
{ time: 201.22, column: 1 },
{ time: 201.47, column: 3 },
{ time: 201.81, column: 3 },
{ time: 202.07, column: 0 },
{ time: 202.75, column: 3 },
{ time: 203.26, column: 3 },
{ time: 203.54, column: 3 },
{ time: 204.08, column: 3 },
{ time: 204.29, column: 1 },
{ time: 204.54, column: 1 },
{ time: 205.01, column: 1 },
{ time: 205.49, column: 1 },
{ time: 205.73, column: 2 },
{ time: 206.02, column: 1 },
{ time: 206.25, column: 1 },
{ time: 206.76, column: 1 },
{ time: 206.98, column: 0 },
{ time: 207.22, column: 2 },
{ time: 207.43, column: 3 },
{ time: 207.70, column: 1 },
{ time: 207.94, column: 0 },
{ time: 208.71, column: 3 },
{ time: 209.18, column: 3 },
{ time: 209.66, column: 1 },
{ time: 209.92, column: 1 },
{ time: 210.22, column: 1 },
{ time: 210.47, column: 2 },
{ time: 210.97, column: 2 },
{ time: 211.42, column: 1 },
{ time: 211.67, column: 3 },
{ time: 211.89, column: 0 },
{ time: 212.16, column: 1 },
{ time: 212.66, column: 0 },
{ time: 212.90, column: 1 },
{ time: 213.12, column: 2 },
{ time: 213.36, column: 2 },
{ time: 213.60, column: 1 },
{ time: 213.89, column: 0 },
{ time: 214.54, column: 0 },
{ time: 215.09, column: 0 },
{ time: 215.35, column: 0 },
{ time: 215.84, column: 0 },
{ time: 216.07, column: 3 },
{ time: 216.35, column: 1 },
{ time: 216.79, column: 2 },
{ time: 217.31, column: 1 },
{ time: 217.54, column: 0 },
{ time: 217.78, column: 3 },
{ time: 218.04, column: 2 },
{ time: 218.54, column: 2 },
{ time: 218.80, column: 2 },
{ time: 219.03, column: 0 },
{ time: 219.26, column: 1 },
{ time: 219.50, column: 3 },
{ time: 219.74, column: 0 },
{ time: 220.47, column: 2 },
{ time: 220.99, column: 1 },
{ time: 221.49, column: 3 },
{ time: 221.99, column: 1 },
    ];

    let tapMode = false;

    // ë°•ì ì°ê¸° ëª¨ë“œ í† ê¸€
    tapBtn.addEventListener("click", () => {
      tapMode = !tapMode;
      tapBtn.textContent = tapMode ? "âœ… ë°•ì ì°ëŠ” ì¤‘ (Space)" : "ğŸ¼ ë°•ì ì°ê¸° ëª¨ë“œ";
    });

    // í‚¤ ì…ë ¥
    window.addEventListener("keydown", (e) => {
      if (tapMode && e.code === "Space") {
        console.log(`{ time: ${bgm.currentTime.toFixed(2)}, column: 0 },`);
      }
      handleHit(e.key.toLowerCase());
    });

    // ğŸ“± ìº”ë²„ìŠ¤ í„°ì¹˜ ì…ë ¥ (í°/íƒœë¸”ë¦¿ìš©)
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const idx = Math.floor(x / colW);
      if (idx >= 0 && idx < columns) {
        handleHit(keyMap[idx]);
      }
    });

    // ë…¸ë˜ ì‹œì‘ / ì¼ì‹œì •ì§€
    startBtn.addEventListener("click", () => {
      if (bgm.paused) {
        bgm.play();
        if (!started) {
          started = true;
          startPerfTime = performance.now();
        }
      } else {
        bgm.pause();
      }
    });

    // ë…¸íŠ¸ ìƒì„±
    function spawnNotes() {
      if (!started) return;
      const now = (performance.now() - startPerfTime) / 1000;
      const travelTime = (judgeLineY - (-20)) / noteSpeed;

      for (let n of chart) {
        if (!n.spawned && now >= n.time - travelTime) {
          n.spawned = true;
          notes.push({ column: n.column, y: -20, active: true });
        }
      }
    }

    // íŒì •ì„  + í‚¤
    function drawLane() {
      ctx.clearRect(0, 0, W, H);

      ctx.fillStyle = "rgba(0,0,0,0.10)";
      ctx.fillRect(0, 0, W, H);

      ctx.strokeStyle = "rgba(255,255,255,0.45)";
      ctx.lineWidth = 2;
      for (let i = 1; i < columns; i++) {
        ctx.beginPath();
        ctx.moveTo(i * colW, 0);
        ctx.lineTo(i * colW, H);
        ctx.stroke();
      }

      ctx.strokeStyle = "#7ab3ff";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(0, judgeLineY);
      ctx.lineTo(W, judgeLineY);
      ctx.stroke();

      ctx.fillStyle = "#fefefe";
      ctx.font = "18px system-ui";
      ctx.textAlign = "center";
      for (let i = 0; i < columns; i++) {
        const x = i * colW + colW / 2;
        ctx.fillText(keyMap[i].toUpperCase(), x, H - 20);
      }
    }

    // ë…¸íŠ¸ ì´ë™ + ê·¸ë¦¬ê¸°
    function drawNotes(dt) {
      const dy = noteSpeed * (dt / 1000);

      for (let n of notes) {
        if (n.active) n.y += dy;
      }

      for (let n of notes) {
        if (!n.active) continue;
        const x = n.column * colW + 10;
        const w = colW - 20;
        ctx.fillStyle = "#ff5fae";
        ctx.fillRect(x, n.y, w, 20);
      }

      // ìë™ Miss ì²˜ë¦¬
      for (let n of notes) {
        if (n.active && n.y > judgeLineY + 60) {
          n.active = false;
          combo = 0;
          results.Miss++;
          showJudge("Miss");
        }
      }
    }

   function handleHit(key) {
  const idx = keyMap.indexOf(key);
  if (idx === -1) return;

  let best = null;
  let distMin = Infinity;

  for (let n of notes) {
    if (!n.active || n.column !== idx) continue;
    const d = Math.abs(n.y - judgeLineY);
    if (d < distMin) {
      distMin = d;
      best = n;
    }
  }

  if (!best) {
    combo = 0;
    showJudge("Miss");
    playHitSound();   // ğŸ‘ˆ íŒì • ì‹¤íŒ¨ë„ â€˜ì¿¡â€™ ì†Œë¦¬ ë‚˜ê²Œ
    return;
  }

  if (distMin <= 25) {
    best.active = false;
    score += 1000;
    combo++;
    showJudge("Perfect");
    playHitSound();   // ğŸ‘ˆ Perfectì¼ ë•Œ íš¨ê³¼ìŒ
  } else if (distMin <= 55) {
    best.active = false;
    score += 500;
    combo++;
    showJudge("Good");
    playHitSound();   // ğŸ‘ˆ Goodì¼ ë•Œ íš¨ê³¼ìŒ
  } else {
    best.active = false;
    combo = 0;
    showJudge("Miss");
    playHitSound();   // ğŸ‘ˆ íƒ€ì´ë° ë§ì´ ë²—ì–´ë‚˜ë„ ëˆ„ë¥¸ ê±´ ì†Œë¦¬
  }
}


    function playHitSound() {
  if (!hitSound) return;
  try {
    hitSound.currentTime = 0;
    hitSound.play();
  } catch (e) {
    // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ì—ì„œ ê°€ë” ì—ëŸ¬ ë‚˜ë„ ê²Œì„ ë©ˆì¶”ì§€ ì•Šê²Œ ë¬´ì‹œ
  }
}


    function showJudge(t) {
      lastJudge = t;
      lastJudgeTimer = 300;
      scoreEl.textContent = score;
      comboEl.textContent = combo;
      judgeEl.textContent = lastJudge;
    }

    // ğŸ”š ê²Œì„ ëë‚¬ëŠ”ì§€ ì²´í¬
    function checkGameEnd() {
      if (!started || resultShown) return;

      const allSpawned = chart.every(n => n.spawned);
      const anyActive = notes.some(n => n.active);

      if (allSpawned && !anyActive) {
        showResult();
      }
    }

    function showResult() {
      resultShown = true;

      rPerfectEl.textContent = results.Perfect;
      rGreatEl.textContent   = results.Great;
      rGoodEl.textContent    = results.Good;
      rMissEl.textContent    = results.Miss;
      rComboEl.textContent   = maxCombo;
      rScoreEl.textContent   = score;

      resultBox.classList.remove("hidden");
      // ì‚´ì§ ë”œë ˆì´ í›„ í˜ì´ë“œì¸
      setTimeout(() => resultBox.classList.add("show"), 10);
    }

    let last = 0;
    function loop(t) {
      const dt = t - last;
      last = t;

      if (lastJudgeTimer > 0) {
        lastJudgeTimer -= dt;
        if (lastJudgeTimer <= 0) judgeEl.textContent = "-";
      }

      drawLane();
      spawnNotes();
      drawNotes(dt);
      checkGameEnd();

      requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);

    // ğŸŒ¸ ì²˜ìŒì— ë‚˜ì˜¬ ê¸°ë³¸ ë°°ê²½ (ë³´ì„ ë…€ ê³ ì • ì‚¬ì§„)
    const baseBg = "no1.jpg";
    canvas.style.backgroundImage = `url("${baseBg}")`;

    // ğŸ 20ì´ˆë§ˆë‹¤ ë°”ë€” ë°°ê²½ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸
    const bgImages = [
      "no1.jpg",
      "no2.jpg",
      "no3.jpg",
      "no4.jpg",
      "no1.jpg",
      "no5.jpg",
      "no6.jpg",
      "no7.jpg"
    ];

    // ğŸ‘‰ -1ì—ì„œ ì‹œì‘í•´ì„œ, ì²« ë²ˆì§¸ êµì²´ ë•Œ dodoë¶€í„° ë‚˜ì˜¤ê²Œ
    let currentBg = -1;

    // 20ì´ˆë§ˆë‹¤ ë°°ê²½ ë³€ê²½
    setInterval(() => {
      currentBg = (currentBg + 1) % bgImages.length;
      canvas.style.backgroundImage = `url("${bgImages[currentBg]}")`;
    }, 15000);
  </script>

</body>
</html>
