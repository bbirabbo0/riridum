<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë³´ì„ ë…€ ë¦¬ë“¬ê²Œì„</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Pretendard", system-ui, sans-serif;
      background: #000;
      color: #222;
    }

    .wrap {
      display: flex;
      gap: 18px;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    /* ğŸ¨ ìº”ë²„ìŠ¤ ë°°ê²½ = ë³´ì„ ë…€ ì‚¬ì§„ */
    canvas {
      width: 600px;
      height: 500px;
      border-radius: 20px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
    }

    .panel {
      width: 260px;
      padding: 16px 18px;
      border-radius: 16px;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 10px 26px rgba(0,0,0,0.5);
      font-size: 14px;
      line-height: 1.7;
    }

    button {
      margin-top: 8px;
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      background: #ff7ac2;
      color: white;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
    }

    .keys { font-weight: 600; }
    .combo { font-weight: 700; color: #ff4ca3; }
    .tap-hint { margin-top: 8px; font-size: 12px; color:#555; }

    /* ğŸ”š ê²°ê³¼ì°½ UI */
    .result {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.88);
      padding: 26px 40px;
      border-radius: 20px;
      text-align: center;
      color: #fff;
      font-size: 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.75);
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 999;
    }
    .result.show {
      opacity: 1;
    }
    .hidden { display: none; }

    .result h2 {
      font-size: 26px;
      margin-bottom: 10px;
    }
    .result p {
      margin: 4px 0;
    }
    .result .big-score {
      margin-top: 10px;
      font-size: 24px;
      font-weight: 700;
      color: #ffd560;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="600" height="500"></canvas>

    <div class="panel">
      <h2>ë³´ì„ ë…€ ë¦¬ë“¬ê²Œì„ ğŸµ</h2>
      <p>ë…¸ë˜ ì¬ìƒ í›„, íŒì •ì„ ì—ì„œ <b>D F J K</b>ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.</p>
      <p class="keys">í‚¤ : D Â· F Â· J Â· K</p>

      <p>ì ìˆ˜: <span id="score">0</span></p>
      <p>ì½¤ë³´: <span id="combo" class="combo">0</span></p>
      <p>íŒì •: <span id="judge">-</span></p>

      <button id="startBtn">â–¶ ë…¸ë˜ ì‹œì‘ / ì¼ì‹œì •ì§€</button>
      <button id="tapBtn">ğŸ¼ ë°•ì ì°ê¸° ëª¨ë“œ</button>
      <p class="tap-hint">
        ë°•ì ì°ê¸° ëª¨ë“œì—ì„œ<br>
        ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ë°•ìì— ë§ê²Œ ëˆ„ë¥´ë©´<br>
        ì½˜ì†”ì— ì‹œê°„ì´ ì°í˜€ìš”.
      </p>
    </div>
  </div>

  <!-- ğŸ”š ê²°ê³¼ì°½ -->
  <div id="result" class="result hidden">
    <h2>RESULT</h2>
    <p>Perfect : <span id="rPerfect">0</span></p>
    <p>Great   : <span id="rGreat">0</span></p>
    <p>Good    : <span id="rGood">0</span></p>
    <p>Miss    : <span id="rMiss">0</span></p>
    <p>Max Combo : <span id="rCombo">0</span></p>
    <p class="big-score">Score : <span id="rScore">0</span></p>
  </div>

  <!-- ë…¸ë˜ íŒŒì¼ -->
  <audio id="bgm" src="inalchi.mp3" preload="auto"></audio>

  <audio id="hit" src="star.mp3.m4a" preload="auto"></audio>


  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const bgm = document.getElementById("bgm");
    const hitSound = document.getElementById("hit");


    const startBtn = document.getElementById("startBtn");
    const tapBtn = document.getElementById("tapBtn");

    const scoreEl = document.getElementById("score");
    const comboEl = document.getElementById("combo");
    const judgeEl = document.getElementById("judge");

    // ê²°ê³¼ì°½ ìš”ì†Œ
    const resultBox  = document.getElementById("result");
    const rPerfectEl = document.getElementById("rPerfect");
    const rGreatEl   = document.getElementById("rGreat");
    const rGoodEl    = document.getElementById("rGood");
    const rMissEl    = document.getElementById("rMiss");
    const rComboEl   = document.getElementById("rCombo");
    const rScoreEl   = document.getElementById("rScore");

    const W = canvas.width;
    const H = canvas.height;
    const columns = 4;
    const keyMap = ["d","f","j","k"];
    const colW = W / columns;
    const judgeLineY = H - 80;
    const noteSpeed = 550; // px/sec

    let notes = [];
    let started = false;
    let startPerfTime = 0;
    let score = 0;
    let combo = 0;
    let lastJudge = "-";
    let lastJudgeTimer = 0;

    // ğŸ”¢ íŒì • ê²°ê³¼ ì§‘ê³„
    let results = {
      Perfect: 0,
      Great: 0,
      Good: 0,
      Miss: 0
    };
    let maxCombo = 0;
    let resultShown = false;

    // ğŸµ ë³´ì„ ë…€ê°€ ì°ì€ ë°•ì ë¦¬ìŠ¤íŠ¸
    const chart = [
      { time: 5.79, column: 2 },
      { time: 6.03, column: 0 },
      { time: 6.35, column: 3 },
      { time: 7.17, column: 1 },
      { time: 7.38, column: 2 },
      { time: 7.58, column: 0 },
      { time: 8.04, column: 3 },
      { time: 8.25, column: 1 },
      { time: 8.47, column: 2 },
      { time: 8.91, column: 0 },
      { time: 9.08, column: 1 },
      { time: 9.32, column: 3 },
      { time: 9.77, column: 2 },
      { time: 9.96, column: 0 },
      { time: 10.20, column: 1 },
      { time: 10.63, column: 3 },
      { time: 10.83, column: 2 },
      { time: 11.09, column: 0 },
      { time: 11.51, column: 1 },
      { time: 11.70, column: 3 },
      { time: 11.91, column: 2 },
      { time: 12.35, column: 0 },
      { time: 12.54, column: 1 },
      { time: 12.80, column: 3 },
      { time: 13.21, column: 2 },
      { time: 13.44, column: 0 },
      { time: 13.65, column: 1 },
      { time: 14.07, column: 3 },
      { time: 14.30, column: 2 },
      { time: 14.51, column: 0 },
      { time: 14.95, column: 1 },
      { time: 15.17, column: 3 },
      { time: 15.37, column: 2 },
      { time: 15.80, column: 0 },
      { time: 16.01, column: 1 },
      { time: 16.26, column: 3 },
      { time: 16.65, column: 2 },
      { time: 16.86, column: 0 },
      { time: 17.07, column: 1 },
      { time: 17.55, column: 3 },
      { time: 17.77, column: 2 },
      { time: 17.97, column: 0 },
      { time: 18.43, column: 1 },
      { time: 18.63, column: 3 },
      { time: 18.84, column: 2 },
      { time: 19.26, column: 0 },
      { time: 19.47, column: 1 },
      { time: 19.68, column: 3 },
      { time: 20.32, column: 2 },
      { time: 21.02, column: 0 },
      { time: 21.24, column: 1 },
      { time: 21.42, column: 3 },
      { time: 21.67, column: 2 },
      { time: 21.86, column: 0 },
      { time: 22.09, column: 1 },
      { time: 22.28, column: 3 },
      { time: 22.54, column: 2 },
      { time: 23.84, column: 0 },
      { time: 24.50, column: 1 },
      { time: 24.70, column: 3 },
      { time: 24.91, column: 2 },
      { time: 25.12, column: 0 },
      { time: 25.35, column: 1 },
      { time: 25.57, column: 3 },
      { time: 25.76, column: 2 },
      { time: 25.98, column: 0 },
      { time: 26.17, column: 1 },
      { time: 26.30, column: 3 },
      { time: 26.49, column: 2 },
      { time: 26.72, column: 0 },
      { time: 26.83, column: 1 },
      { time: 27.28, column: 3 },
      { time: 27.55, column: 1 },
      { time: 27.74, column: 3 },
      { time: 27.94, column: 2 },
      { time: 28.12, column: 0 },
      { time: 28.33, column: 1 },
      { time: 28.76, column: 3 },
      { time: 28.95, column: 2 },
      { time: 29.20, column: 0 },
      { time: 29.44, column: 1 },
      { time: 29.90, column: 3 },
      { time: 30.69, column: 2 },
      { time: 31.37, column: 0 },
      { time: 31.59, column: 1 },
      { time: 31.81, column: 2 },
      { time: 32.03, column: 3 },
      { time: 32.25, column: 1 },
      { time: 32.47, column: 0 },
      { time: 32.69, column: 3 },
      { time: 32.89, column: 2 },
      { time: 33.09, column: 1 },
      { time: 33.32, column: 0 },
      { time: 33.54, column: 3 },
      { time: 33.96, column: 2 },
      { time: 34.15, column: 1 },
      { time: 34.37, column: 3 },
      { time: 34.59, column: 0 },
      { time: 34.86, column: 2 },
      { time: 35.08, column: 1 },
      { time: 35.29, column: 3 },
      { time: 35.52, column: 0 },
      { time: 35.73, column: 2 },
      { time: 35.94, column: 1 },
      { time: 36.14, column: 3 },
      { time: 36.35, column: 0 },
      { time: 36.57, column: 2 },
      { time: 37.01, column: 1 },
      { time: 37.44, column: 3 },
      { time: 37.84, column: 0 },
      { time: 38.05, column: 2 },
      { time: 38.26, column: 1 },
      { time: 38.50, column: 3 },
      { time: 38.70, column: 0 },
      { time: 38.92, column: 1 },
      { time: 39.13, column: 3 },
      { time: 39.35, column: 2 },
      { time: 39.55, column: 0 },
      { time: 39.96, column: 1 },
      { time: 40.85, column: 3 },
      { time: 41.29, column: 2 },
      { time: 41.74, column: 0 },
      { time: 42.18, column: 1 },
      { time: 42.58, column: 3 },
      { time: 42.77, column: 2 },
      { time: 42.99, column: 0 },
      { time: 43.17, column: 1 },
      { time: 43.43, column: 3 },
      { time: 43.85, column: 2 },
      { time: 44.48, column: 0 },
      { time: 45.17, column: 1 },
      { time: 45.39, column: 3 },
      { time: 45.60, column: 2 },
      { time: 45.80, column: 0 },
      { time: 46.03, column: 1 },
      { time: 46.24, column: 3 },
      { time: 46.46, column: 2 },
      { time: 46.68, column: 0 },
      { time: 46.90, column: 1 },
      { time: 47.11, column: 3 },
      { time: 47.33, column: 2 },
      { time: 47.74, column: 0 },
      { time: 47.95, column: 1 },
      { time: 48.20, column: 3 },
      { time: 48.62, column: 2 },
      { time: 48.81, column: 0 },
      { time: 49.06, column: 1 },
      { time: 49.49, column: 3 },
      { time: 49.69, column: 2 },
      { time: 49.91, column: 0 },
      { time: 50.34, column: 1 },
      { time: 50.78, column: 3 },
      { time: 51.23, column: 2 },
      { time: 51.43, column: 0 },
      { time: 51.64, column: 1 },
      { time: 52.10, column: 3 },
      { time: 52.30, column: 2 },
      { time: 52.51, column: 0 },
      { time: 52.98, column: 1 },
      { time: 53.19, column: 3 },
      { time: 53.38, column: 2 },
      { time: 53.80, column: 0 },
      { time: 54.00, column: 1 },
      { time: 54.23, column: 3 },
      { time: 54.90, column: 2 },
      { time: 55.45, column: 0 },
      { time: 55.61, column: 1 },
      { time: 55.80, column: 3 },
      { time: 56.01, column: 2 },
      { time: 56.19, column: 0 },
      { time: 56.41, column: 1 },
      { time: 56.61, column: 3 },
      { time: 56.83, column: 2 },
      { time: 57.05, column: 0 },
      { time: 57.26, column: 1 },
      { time: 57.46, column: 3 },
      { time: 57.69, column: 2 },
      { time: 58.17, column: 2 },
      { time: 58.57, column: 1 },
      { time: 59.03, column: 3 },
      { time: 59.43, column: 0 },
      { time: 59.87, column: 2 },
      { time: 60.08, column: 1 },
      { time: 60.29, column: 3 },
      { time: 60.49, column: 0 },
      { time: 60.74, column: 2 },
      { time: 61.16, column: 1 },
      { time: 61.60, column: 3 },
      { time: 62.06, column: 0 },
      { time: 62.49, column: 2 },
      { time: 62.93, column: 1 },
      { time: 63.37, column: 3 },
      { time: 63.77, column: 0 },
      { time: 64.20, column: 2 },
      { time: 64.65, column: 1 },
      { time: 65.13, column: 3 },
      { time: 65.90, column: 0 },
      { time: 66.11, column: 2 },
      { time: 66.33, column: 1 },
      { time: 66.55, column: 3 },
      { time: 66.76, column: 0 },
      { time: 66.97, column: 2 },
      { time: 67.19, column: 1 },
      { time: 67.38, column: 3 },
      { time: 67.59, column: 0 },
      { time: 67.81, column: 2 },
      { time: 68.04, column: 1 },
      { time: 68.48, column: 3 },
      { time: 68.72, column: 0 },
      { time: 68.91, column: 2 },
      { time: 69.10, column: 1 },
      { time: 69.31, column: 3 },
      { time: 69.74, column: 0 },
      { time: 70.18, column: 2 },
      { time: 70.43, column: 1 },
      { time: 70.54, column: 3 },
      { time: 70.68, column: 0 },
      { time: 70.92, column: 2 },
      { time: 71.12, column: 1 },
      { time: 71.53, column: 3 },
      { time: 72.17, column: 0 },
      { time: 73.32, column: 2 },
      { time: 73.67, column: 1 },
      { time: 73.87, column: 3 },
      { time: 74.10, column: 0 },
      { time: 74.32, column: 2 },
      { time: 74.53, column: 1 },
      { time: 74.94, column: 3 },
      { time: 75.42, column: 0 },
      { time: 75.83, column: 2 },
      { time: 76.28, column: 1 },
      { time: 76.71, column: 3 },
      { time: 77.14, column: 0 },
      { time: 77.58, column: 2 },
      { time: 78.00, column: 1 },
      { time: 78.43, column: 3 },
      { time: 78.86, column: 0 },
      { time: 79.32, column: 2 },
      { time: 79.76, column: 1 },
      { time: 79.93, column: 3 },
      { time: 80.14, column: 0 },
      { time: 80.34, column: 2 },
      { time: 80.57, column: 1 },
      { time: 80.86, column: 3 },
      { time: 81.22, column: 0 },
      { time: 82.28, column: 2 },
      { time: 82.57, column: 1 },
      { time: 82.76, column: 3 },
      { time: 82.96, column: 0 },
      { time: 83.17, column: 2 },
      { time: 83.35, column: 1 },
      { time: 83.60, column: 3 },
      { time: 83.79, column: 0 },
      { time: 84.03, column: 2 },
      { time: 84.25, column: 1 },
      { time: 84.48, column: 3 },
      { time: 84.66, column: 0 },
      { time: 84.87, column: 2 },
      { time: 85.05, column: 1 },
      { time: 85.27, column: 3 },
      { time: 85.44, column: 0 },
      { time: 85.64, column: 2 },
      { time: 85.80, column: 1 },
      { time: 85.97, column: 3 },
      { time: 86.18, column: 0 },
      { time: 86.61, column: 2 },
      { time: 86.83, column: 1 },
      { time: 87.06, column: 3 },
      { time: 87.49, column: 0 },
      { time: 87.70, column: 2 },
      { time: 87.93, column: 1 },
      { time: 88.31, column: 3 },
      { time: 88.51, column: 0 },
      { time: 88.76, column: 2 },
      { time: 89.19, column: 1 },
      { time: 89.39, column: 3 },
      { time: 89.64, column: 0 },
      { time: 90.05, column: 2 },
      { time: 90.25, column: 1 },
      { time: 90.46, column: 3 },
      { time: 90.93, column: 0 },
      { time: 91.14, column: 2 },
      { time: 91.37, column: 1 },
      { time: 91.81, column: 3 },
      { time: 92.01, column: 0 },
      { time: 92.24, column: 2 },
      { time: 92.87, column: 1 },
      { time: 93.08, column: 3 },
      { time: 93.23, column: 0 },
      { time: 93.34, column: 2 },
      { time: 93.46, column: 1 },
      { time: 93.59, column: 3 },
      { time: 93.70, column: 0 },
      { time: 93.81, column: 2 },
      { time: 93.92, column: 1 },
      { time: 94.02, column: 3 },
      { time: 94.20, column: 0 },
      { time: 94.46, column: 2 },
      { time: 94.58, column: 1 },
      { time: 94.70, column: 3 },
      { time: 94.82, column: 0 },
      { time: 94.91, column: 2 },
      { time: 95.03, column: 1 },
      { time: 95.15, column: 3 },
      { time: 95.27, column: 0 },
      { time: 95.39, column: 2 },
      { time: 95.50, column: 1 },
      { time: 95.63, column: 3 },
      { time: 96.12, column: 0 },
      { time: 96.25, column: 2 },
      { time: 96.39, column: 1 },
      { time: 96.55, column: 3 },
      { time: 96.78, column: 0 },
      { time: 96.96, column: 2 },
      { time: 97.19, column: 1 },
      { time: 97.29, column: 3 },
      { time: 97.45, column: 0 },
      { time: 97.68, column: 2 },
      { time: 97.85, column: 1 },
      { time: 98.09, column: 3 },
      { time: 98.26, column: 0 },
      { time: 98.48, column: 2 },
      { time: 98.74, column: 1 },
      { time: 98.92, column: 3 },
      { time: 99.14, column: 0 },
      { time: 99.60, column: 2 },
      { time: 99.82, column: 1 },
      { time: 100.00, column: 3 },
      { time: 100.15, column: 0 },
      { time: 100.29, column: 2 },
      { time: 100.52, column: 1 },
      { time: 100.67, column: 3 },
      { time: 100.80, column: 0 },
      { time: 100.93, column: 2 },
      { time: 101.05, column: 0 },
      { time: 101.33, column: 0 },
      { time: 101.47, column: 2 },
      { time: 101.61, column: 1 },
      { time: 101.73, column: 1 },
      { time: 101.88, column: 0 },
      { time: 102.12, column: 0 },
      { time: 102.30, column: 0 },
      { time: 102.57, column: 2 },
      { time: 103.03, column: 1 },
      { time: 103.24, column: 1 },
      { time: 103.46, column: 0 },
      { time: 103.69, column: 0 },
      { time: 103.93, column: 2 },
      { time: 104.15, column: 1 },
      { time: 104.37, column: 1 },
      { time: 104.58, column: 3 },
      { time: 104.79, column: 1 },
      { time: 104.98, column: 1 },
      { time: 105.20, column: 0 },
      { time: 105.43, column: 0 },
      { time: 105.65, column: 0 },
      { time: 105.83, column: 0 },
      { time: 106.04, column: 2 },
      { time: 106.48, column: 1 },
      { time: 106.71, column: 1 },
      { time: 106.93, column: 1 },
      { time: 107.16, column: 0 },
      { time: 107.37, column: 0 },
      { time: 107.59, column: 1 },
      { time: 107.79, column: 3 },
      { time: 108.00, column: 2 },
      { time: 108.21, column: 0 },
      { time: 108.41, column: 2 },
      { time: 108.64, column: 2 },
      { time: 108.83, column: 2 },
      { time: 109.06, column: 2 },
      { time: 109.23, column: 2 },
      { time: 109.54, column: 2 },
      { time: 109.94, column: 2 },
      { time: 110.13, column: 0 },
      { time: 110.36, column: 1 },
      { time: 110.80, column: 0 },
      { time: 111.01, column: 3 },
      { time: 111.22, column: 1 },
      { time: 111.65, column: 1 },
      { time: 111.85, column: 0 },
      { time: 112.06, column: 3 },
      { time: 112.50, column: 0 },
      { time: 112.71, column: 3 },
      { time: 112.97, column: 1 },
      { time: 113.40, column: 3 },
      { time: 113.63, column: 2 },
      { time: 113.85, column: 1 },
      { time: 114.07, column: 1 },
      { time: 114.29, column: 1 },
      { time: 114.49, column: 3 },
      { time: 114.70, column: 1 },
      { time: 114.91, column: 2 },
      { time: 115.12, column: 0 },
      { time: 115.33, column: 0 },
      { time: 115.54, column: 1 },
      { time: 115.75, column: 3 },
      { time: 115.97, column: 3 },
      { time: 116.19, column: 2 },
      { time: 116.43, column: 0 },
      { time: 116.64, column: 2 },
      { time: 116.85, column: 1 },
      { time: 117.07, column: 3 },
      { time: 117.33, column: 1 },
      { time: 117.52, column: 1 },
      { time: 117.75, column: 3 },
      { time: 117.96, column: 0 },
      { time: 118.17, column: 3 },
      { time: 118.40, column: 1 },
      { time: 118.61, column: 0 },
      { time: 118.89, column: 0 },
      { time: 119.18, column: 1 },
      { time: 119.39, column: 2 },
      { time: 119.63, column: 2 },
      { time: 119.87, column: 2 },
      { time: 120.08, column: 0 },
      { time: 120.27, column: 3 },
      { time: 120.49, column: 3 },
      { time: 120.69, column: 2 },
      { time: 120.92, column: 1 },
      { time: 121.15, column: 1 },
      { time: 121.39, column: 2 },
      { time: 121.62, column: 1 },
      { time: 121.83, column: 1 },
      { time: 122.05, column: 3 },
      { time: 122.25, column: 1 },
      { time: 122.49, column: 2 },
      { time: 122.72, column: 0 },
      { time: 122.92, column: 2 },
      { time: 123.12, column: 1 },
      { time: 123.35, column: 0 },
      { time: 123.57, column: 3 },
      { time: 124.59, column: 3 },
      { time: 124.82, column: 1 },
      { time: 125.05, column: 1 },
      { time: 125.27, column: 2 },
      { time: 125.48, column: 1 },
      { time: 125.80, column: 1 },
      { time: 126.14, column: 1 },
      { time: 126.31, column: 1 },
      { time: 126.53, column: 1 },
      { time: 126.76, column: 3 },
      { time: 127.18, column: 1 },
      { time: 127.64, column: 3 },
      { time: 128.10, column: 3 },
      { time: 128.53, column: 0 },
      { time: 128.95, column: 0 },
      { time: 129.42, column: 2 },
      { time: 129.84, column: 1 },
      { time: 130.28, column: 2 },
      { time: 130.68, column: 3 },
      { time: 130.95, column: 2 },
      { time: 131.13, column: 2 },
      { time: 131.32, column: 3 },
      { time: 131.52, column: 0 },
      { time: 131.73, column: 1 },
      { time: 131.95, column: 3 },
      { time: 132.17, column: 3 },
      { time: 132.39, column: 2 },
      { time: 132.67, column: 3 },
      { time: 132.87, column: 3 },
      { time: 133.07, column: 1 },
      { time: 133.26, column: 2 },
      { time: 133.47, column: 3 },
      { time: 133.66, column: 1 },
      { time: 133.91, column: 3 },
      { time: 134.30, column: 2 },
      { time: 134.62, column: 0 },
      { time: 134.98, column: 2 },
      { time: 135.18, column: 2 },
      { time: 135.44, column: 0 },
      { time: 135.68, column: 0 },
      { time: 135.88, column: 0 },
      { time: 136.08, column: 0 },
      { time: 136.29, column: 2 },
      { time: 136.50, column: 2 },
      { time: 136.70, column: 3 },
      { time: 137.09, column: 0 },
      { time: 137.67, column: 2 },
      { time: 137.81, column: 2 },
      { time: 138.40, column: 3 },
      { time: 138.62, column: 3 },
      { time: 138.85, column: 2 },
      { time: 139.06, column: 3 },
      { time: 139.30, column: 3 },
      { time: 139.72, column: 2 },
      { time: 140.18, column: 1 },
      { time: 140.65, column: 3 },
      { time: 141.03, column: 2 },
      { time: 141.45, column: 1 },
      { time: 141.66, column: 0 },
      { time: 141.88, column: 2 },
      { time: 142.31, column: 1 },
      { time: 142.74, column: 3 },
      { time: 143.01, column: 2 },
      { time: 143.10, column: 1 },
      { time: 143.34, column: 1 },
      { time: 143.62, column: 2 },
      { time: 144.02, column: 1 },
      { time: 144.46, column: 2 },
      { time: 144.90, column: 2 },
      { time: 145.32, column: 2 },
      { time: 145.55, column: 3 },
      { time: 145.77, column: 0 },
      { time: 145.98, column: 2 },
      { time: 146.20, column: 3 },
      { time: 146.50, column: 1 },
      { time: 146.64, column: 0 },
      { time: 146.86, column: 1 },
      { time: 147.06, column: 0 },
      { time: 147.48, column: 0 },
      { time: 147.92, column: 0 },
      { time: 148.19, column: 0 },
      { time: 148.35, column: 1 },
      { time: 148.59, column: 3 },
      { time: 148.78, column: 2 },
      { time: 148.98, column: 0 },
      { time: 149.24, column: 0 },
      { time: 149.67, column: 3 },
      { time: 149.91, column: 0 },
      { time: 150.01, column: 1 },
      { time: 150.15, column: 2 },
      { time: 150.38, column: 3 },
      { time: 150.55, column: 2 },
      { time: 150.76, column: 0 },
      { time: 150.96, column: 2 },
      { time: 151.38, column: 0 },
      { time: 151.59, column: 0 },
      { time: 151.82, column: 1 },
      { time: 152.06, column: 3 },
      { time: 152.27, column: 1 },
      { time: 152.47, column: 1 },
      { time: 152.69, column: 3 },
      { time: 152.94, column: 0 },
      { time: 153.14, column: 1 },
      { time: 153.39, column: 0 },
      { time: 153.74, column: 3 },
      { time: 154.13, column: 2 },
      { time: 154.37, column: 3 },
      { time: 154.83, column: 1 },
      { time: 155.09, column: 0 },
      { time: 155.28, column: 0 },
      { time: 155.47, column: 0 },
      { time: 155.69, column: 0 },
      { time: 155.93, column: 2 },
      { time: 156.13, column: 1 },
      { time: 156.35, column: 3 },
      { time: 156.58, column: 2 },
      { time: 156.77, column: 2 },
      { time: 156.99, column: 3 },
      { time: 157.21, column: 1 },
      { time: 157.40, column: 0 },
      { time: 157.54, column: 3 },
      { time: 157.75, column: 1 },
      { time: 157.83, column: 3 },
      { time: 157.94, column: 2 },
      { time: 158.08, column: 3 },
      { time: 158.26, column: 1 },
      { time: 158.44, column: 1 },
      { time: 158.67, column: 1 },
      { time: 159.10, column: 1 },
      { time: 159.35, column: 2 },
      { time: 159.54, column: 1 },
      { time: 159.98, column: 0 },
      { time: 160.20, column: 1 },
      { time: 160.40, column: 3 },
      { time: 160.85, column: 3 },
      { time: 161.06, column: 0 },
      { time: 161.25, column: 3 },
      { time: 161.72, column: 2 },
      { time: 161.94, column: 1 },
      { time: 162.12, column: 3 },
      { time: 162.60, column: 3 },
      { time: 162.80, column: 2 },
      { time: 163.01, column: 1 },
      { time: 163.49, column: 1 },
      { time: 163.68, column: 2 },
      { time: 163.92, column: 1 },
      { time: 164.32, column: 1 },
      { time: 164.53, column: 1 },
      { time: 164.73, column: 1 },
      { time: 165.17, column: 0 },
      { time: 165.41, column: 1 },
      { time: 165.64, column: 2 },
      { time: 165.86, column: 1 },
      { time: 166.07, column: 0 },
      { time: 166.27, column: 1 },
      { time: 166.47, column: 3 },
      { time: 166.72, column: 2 },
      { time: 166.93, column: 1 },
      { time: 167.13, column: 3 },
      { time: 167.35, column: 1 },
      { time: 167.61, column: 2 },
      { time: 167.79, column: 2 },
      { time: 168.19, column: 3 },
      { time: 168.70, column: 0 },
      { time: 168.92, column: 1 },
      { time: 169.49, column: 0 },
      { time: 169.71, column: 3 },
      { time: 169.94, column: 2 },
      { time: 170.13, column: 1 },
      { time: 170.37, column: 2 },
      { time: 170.59, column: 2 },
      { time: 170.81, column: 2 },
      { time: 171.02, column: 0 },
      { time: 171.22, column: 0 },
      { time: 171.43, column: 1 },
      { time: 171.65, column: 3 },
      { time: 172.08, column: 1 },
      { time: 172.29, column: 1 },
      { time: 172.50, column: 2 },
      { time: 172.94, column: 3 },
      { time: 173.13, column: 0 },
      { time: 173.35, column: 2 },
      { time: 173.79, column: 1 },
      { time: 174.01, column: 0 },
      { time: 174.22, column: 1 },
      { time: 174.64, column: 3 },
      { time: 174.84, column: 2 },
      { time: 175.10, column: 1 },
      { time: 175.52, column: 0 },
      { time: 175.73, column: 1 },
      { time: 175.94, column: 3 },
      { time: 176.37, column: 1 },
      { time: 176.57, column: 1 },
      { time: 176.81, column: 3 },
      { time: 177.28, column: 2 },
      { time: 177.47, column: 0 },
      { time: 177.67, column: 2 },
      { time: 178.14, column: 1 },
      { time: 178.35, column: 3 },
      { time: 178.57, column: 2 },
    ];

    let tapMode = false;

    // ë°•ì ì°ê¸° ëª¨ë“œ í† ê¸€
    tapBtn.addEventListener("click", () => {
      tapMode = !tapMode;
      tapBtn.textContent = tapMode ? "âœ… ë°•ì ì°ëŠ” ì¤‘ (Space)" : "ğŸ¼ ë°•ì ì°ê¸° ëª¨ë“œ";
    });

    // í‚¤ ì…ë ¥
    window.addEventListener("keydown", (e) => {
      if (tapMode && e.code === "Space") {
        console.log(`{ time: ${bgm.currentTime.toFixed(2)}, column: 0 },`);
      }
      handleHit(e.key.toLowerCase());
    });

    // ğŸ“± ìº”ë²„ìŠ¤ í„°ì¹˜ ì…ë ¥ (í°/íƒœë¸”ë¦¿ìš©)
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const idx = Math.floor(x / colW);
      if (idx >= 0 && idx < columns) {
        handleHit(keyMap[idx]);
      }
    });

    // ë…¸ë˜ ì‹œì‘ / ì¼ì‹œì •ì§€
    startBtn.addEventListener("click", () => {
      if (bgm.paused) {
        bgm.play();
        if (!started) {
          started = true;
          startPerfTime = performance.now();
        }
      } else {
        bgm.pause();
      }
    });

    // ë…¸íŠ¸ ìƒì„±
    function spawnNotes() {
      if (!started) return;
      const now = (performance.now() - startPerfTime) / 1000;
      const travelTime = (judgeLineY - (-20)) / noteSpeed;

      for (let n of chart) {
        if (!n.spawned && now >= n.time - travelTime) {
          n.spawned = true;
          notes.push({ column: n.column, y: -20, active: true });
        }
      }
    }

    // íŒì •ì„  + í‚¤
    function drawLane() {
      ctx.clearRect(0, 0, W, H);

      ctx.fillStyle = "rgba(0,0,0,0.10)";
      ctx.fillRect(0, 0, W, H);

      ctx.strokeStyle = "rgba(255,255,255,0.45)";
      ctx.lineWidth = 2;
      for (let i = 1; i < columns; i++) {
        ctx.beginPath();
        ctx.moveTo(i * colW, 0);
        ctx.lineTo(i * colW, H);
        ctx.stroke();
      }

      ctx.strokeStyle = "#7ab3ff";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(0, judgeLineY);
      ctx.lineTo(W, judgeLineY);
      ctx.stroke();

      ctx.fillStyle = "#fefefe";
      ctx.font = "18px system-ui";
      ctx.textAlign = "center";
      for (let i = 0; i < columns; i++) {
        const x = i * colW + colW / 2;
        ctx.fillText(keyMap[i].toUpperCase(), x, H - 20);
      }
    }

    // ë…¸íŠ¸ ì´ë™ + ê·¸ë¦¬ê¸°
    function drawNotes(dt) {
      const dy = noteSpeed * (dt / 1000);

      for (let n of notes) {
        if (n.active) n.y += dy;
      }

      for (let n of notes) {
        if (!n.active) continue;
        const x = n.column * colW + 10;
        const w = colW - 20;
        ctx.fillStyle = "#ff5fae";
        ctx.fillRect(x, n.y, w, 20);
      }

      // ìë™ Miss ì²˜ë¦¬
      for (let n of notes) {
        if (n.active && n.y > judgeLineY + 60) {
          n.active = false;
          combo = 0;
          results.Miss++;
          showJudge("Miss");
        }
      }
    }

   function handleHit(key) {
  const idx = keyMap.indexOf(key);
  if (idx === -1) return;

  let best = null;
  let distMin = Infinity;

  for (let n of notes) {
    if (!n.active || n.column !== idx) continue;
    const d = Math.abs(n.y - judgeLineY);
    if (d < distMin) {
      distMin = d;
      best = n;
    }
  }

  if (!best) {
    combo = 0;
    showJudge("Miss");
    playHitSound();   // ğŸ‘ˆ íŒì • ì‹¤íŒ¨ë„ â€˜ì¿¡â€™ ì†Œë¦¬ ë‚˜ê²Œ
    return;
  }

  if (distMin <= 25) {
    best.active = false;
    score += 1000;
    combo++;
    showJudge("Perfect");
    playHitSound();   // ğŸ‘ˆ Perfectì¼ ë•Œ íš¨ê³¼ìŒ
  } else if (distMin <= 55) {
    best.active = false;
    score += 500;
    combo++;
    showJudge("Good");
    playHitSound();   // ğŸ‘ˆ Goodì¼ ë•Œ íš¨ê³¼ìŒ
  } else {
    best.active = false;
    combo = 0;
    showJudge("Miss");
    playHitSound();   // ğŸ‘ˆ íƒ€ì´ë° ë§ì´ ë²—ì–´ë‚˜ë„ ëˆ„ë¥¸ ê±´ ì†Œë¦¬
  }
}


    function playHitSound() {
  if (!hitSound) return;
  try {
    hitSound.currentTime = 0;
    hitSound.play();
  } catch (e) {
    // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ì—ì„œ ê°€ë” ì—ëŸ¬ ë‚˜ë„ ê²Œì„ ë©ˆì¶”ì§€ ì•Šê²Œ ë¬´ì‹œ
  }
}


    function showJudge(t) {
      lastJudge = t;
      lastJudgeTimer = 300;
      scoreEl.textContent = score;
      comboEl.textContent = combo;
      judgeEl.textContent = lastJudge;
    }

    // ğŸ”š ê²Œì„ ëë‚¬ëŠ”ì§€ ì²´í¬
    function checkGameEnd() {
      if (!started || resultShown) return;

      const allSpawned = chart.every(n => n.spawned);
      const anyActive = notes.some(n => n.active);

      if (allSpawned && !anyActive) {
        showResult();
      }
    }

    function showResult() {
      resultShown = true;

      rPerfectEl.textContent = results.Perfect;
      rGreatEl.textContent   = results.Great;
      rGoodEl.textContent    = results.Good;
      rMissEl.textContent    = results.Miss;
      rComboEl.textContent   = maxCombo;
      rScoreEl.textContent   = score;

      resultBox.classList.remove("hidden");
      // ì‚´ì§ ë”œë ˆì´ í›„ í˜ì´ë“œì¸
      setTimeout(() => resultBox.classList.add("show"), 10);
    }

    let last = 0;
    function loop(t) {
      const dt = t - last;
      last = t;

      if (lastJudgeTimer > 0) {
        lastJudgeTimer -= dt;
        if (lastJudgeTimer <= 0) judgeEl.textContent = "-";
      }

      drawLane();
      spawnNotes();
      drawNotes(dt);
      checkGameEnd();

      requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);

    // ğŸŒ¸ ì²˜ìŒì— ë‚˜ì˜¬ ê¸°ë³¸ ë°°ê²½ (ë³´ì„ ë…€ ê³ ì • ì‚¬ì§„)
    const baseBg = "no1.jpg";
    canvas.style.backgroundImage = `url("${baseBg}")`;

    // ğŸ 20ì´ˆë§ˆë‹¤ ë°”ë€” ë°°ê²½ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸
    const bgImages = [
      "no1.jpg",
      "no2.jpg",
      "no3.jpg",
      "no4.jpg",
      "no1.jpg",
      "no5.jpg",
      "no6.jpg",
      "no7.jpg"
    ];

    // ğŸ‘‰ -1ì—ì„œ ì‹œì‘í•´ì„œ, ì²« ë²ˆì§¸ êµì²´ ë•Œ dodoë¶€í„° ë‚˜ì˜¤ê²Œ
    let currentBg = -1;

    // 20ì´ˆë§ˆë‹¤ ë°°ê²½ ë³€ê²½
    setInterval(() => {
      currentBg = (currentBg + 1) % bgImages.length;
      canvas.style.backgroundImage = `url("${bgImages[currentBg]}")`;
    }, 15000);
  </script>

</body>
</html>
